<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Madame Lunara</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: #f1e9f9;
    }

    #chat {
      max-width: 600px;
      margin: 0 auto;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .mensaje {
      padding: 10px 15px;
      border-radius: 20px;
      max-width: 80%;
      line-height: 1.4;
    }

    .madame {
      align-self: flex-start;
      background: #e0c3fc;
      color: #333;
    }

    .usuario {
      align-self: flex-end;
      background: #b388eb;
      color: white;
    }

    #entrada {
      display: flex;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      max-width: 600px;
      margin: auto;
      background: white;
      padding: 10px;
      border-top: 1px solid #ccc;
    }

    #texto {
      flex: 1;
      padding: 10px;
      font-size: 16px;
      border-radius: 20px;
      border: 1px solid #ccc;
    }

    #enviar {
      background: #b388eb;
      color: white;
      border: none;
      border-radius: 20px;
      margin-left: 10px;
      padding: 0 20px;
      cursor: pointer;
    }

    #botonSiguiente {
      position: fixed;
      bottom: 70px;
      right: 20px;
      background-color: #b388eb;
      color: white;
      border: none;
      border-radius: 25px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      display: none;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    img.carta {
      max-width: 150px;
      border-radius: 10px;
      margin-top: 10px;
    }
  </style>
</head>
<body>

  <div id="chat"></div>

  <div id="entrada">
    <input type="text" id="texto" placeholder="Escribí tu mensaje..." />
    <button id="enviar">Enviar</button>
  </div>

  <button id="botonSiguiente">Ver siguiente carta</button>

  <script>
  let estado = "saludo";
let nombre = "";
let sexo = "";
let historia = "";
let cartasSeleccionadas = [];
let indiceCarta = 0;

const mazo = [
  { nombre: "La Estrella", img: "https://upload.wikimedia.org/wikipedia/commons/d/db/RWS_Tarot_17_Star.jpg", breve: "Esperanza, guía, inspiración divina." },
  { nombre: "La Muerte", img: "https://upload.wikimedia.org/wikipedia/commons/d/d7/RWS_Tarot_13_Death.jpg", breve: "Fin de una etapa, transformación y renacimiento." },
  { nombre: "El Sol", img: "https://upload.wikimedia.org/wikipedia/commons/1/17/RWS_Tarot_19_Sun.jpg", breve: "Claridad, éxito rotundo, felicidad." },
  { nombre: "El Colgado", img: "https://upload.wikimedia.org/wikipedia/commons/2/2b/RWS_Tarot_12_Hanged_Man.jpg", breve: "Pausa forzada, nueva visión, entrega." },
  { nombre: "La Luna", img: "https://upload.wikimedia.org/wikipedia/commons/7/7f/RWS_Tarot_18_Moon.jpg", breve: "Confusión, intuición profunda, sombras." },
  { nombre: "La Templanza", img: "https://upload.wikimedia.org/wikipedia/commons/f/f8/RWS_Tarot_14_Temperance.jpg", breve: "Armonía, paciencia, equilibrio espiritual." }
];

const chat = document.getElementById("chat");
const texto = document.getElementById("texto");
const enviar = document.getElementById("enviar");
const botonSiguiente = document.getElementById("botonSiguiente");

function agregarMensaje(texto, clase) {
  const burbuja = document.createElement("div");
  burbuja.className = "mensaje " + clase;
  burbuja.innerHTML = texto;
  chat.appendChild(burbuja);
  chat.scrollTop = chat.scrollHeight;
}

function mostrarCarta() {
  const carta = cartasSeleccionadas[indiceCarta];
  agregarMensaje(`<strong>${carta.nombre}</strong><br><img src="${carta.img}" class="carta"><br>${carta.breve}`, "madame");

  indiceCarta++;
  if (indiceCarta < 3) {
    botonSiguiente.style.display = "block";
  } else {
    botonSiguiente.style.display = "none";
    setTimeout(() => {
      interpretarCartas();
    }, 2000);
  }
}

async function interpretarCartas() {
  const nombres = cartasSeleccionadas.map(c => c.nombre).join(", ");
  const prompt = `Estas son las cartas del tarot: ${nombres}. Por favor, dame una interpretación espiritual y simbólica de estas tres cartas combinadas, como si fueras una tarotista sabia, empática y directa.`;

  agregarMensaje("Consultando a los espíritus...", "madame");

  try {
    const respuesta = await fetch("/.netlify/functions/api", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        messages: [
          {
            role: "system",
            content: "Sos Madame Lunara, una tarotista espiritual, empática, sabia y directa. Respondés en tono místico pero claro.",
          },
          {
            role: "user",
            content: `Consultante: ${nombre}, que se identifica como ${sexo}, ha contado: "${historia}". Las cartas son: ${cartas.join(", ")}. Realizá una interpretación mística y emocional combinada.`,
          }
        ]
      }),
    });

    const data = await respuesta.json();
    agregarMensaje(data.respuesta || "No pude interpretar las cartas esta vez.", "madame");

  } catch (error) {
    agregarMensaje("Error al contactar al oráculo: " + error.message, "madame");
  }
}

function procesarEntrada(entrada) {
  agregarMensaje(entrada, "usuario");

  if (estado === "saludo") {
    const hora = new Date().getHours();
    const saludo = hora < 12 ? "Buenos días" : hora < 20 ? "Buenas tardes" : "Buenas noches";
    agregarMensaje(`${saludo.italics()}, soy Madame Lunara. ¿Cuál es tu nombre?`, "madame");
    estado = "pedirNombre";

  } else if (estado === "pedirNombre") {
    nombre = entrada;
    agregarMensaje(`Un gusto, ${nombre}. ¿Sos hombre, mujer u otra identidad?`, "madame");
    estado = "pedirSexo";

  } else if (estado === "pedirSexo") {
    sexo = entrada.toLowerCase();
    agregarMensaje(`Gracias. Visualizá lo que queres saber.. Si querés me podes contar o directamente tiramos las cartas. Comenzamos?`, "madame");
    estado = "preguntarHistoria";

  } else if (estado === "preguntarHistoria") {
    if (entrada.toLowerCase().includes("carta")) {
      historia = "";
    } else {
      historia = entrada;
    }
    agregarMensaje("Me concentro... barajo las cartas... Vamos con la primera carta.", "madame");
    cartasSeleccionadas = mazo.sort(() => 0.5 - Math.random()).slice(0, 3);
    setTimeout(() => mostrarCarta(), 2000);
    estado = "tirandoCartas";

  } else if (estado === "tirandoCartas") {
    agregarMensaje("Usá el botón para ver la siguiente carta.", "madame");
  }
}

enviar.addEventListener("click", () => {
  const entrada = texto.value.trim();
  if (entrada) {
    procesarEntrada(entrada);
    texto.value = "";
  }
});

texto.addEventListener("keypress", (e) => {
  if (e.key === "Enter") {
    enviar.click();
  }
});

botonSiguiente.addEventListener("click", () => {
  botonSiguiente.style.display = "none";
  mostrarCarta();
});

// Disparo inicial
agregarMensaje("✨ Bienvenido al tarot de Madame Lunara ✨", "madame");
setTimeout(() => procesarEntrada(""), 1000);

  </script>
</body>
</html>
